# opcheck精度预检功能使用指南
## 1. 环境准备
### 1.1 cann包与atb包
```
source ./Ascend/ascend-toolkit/set_env.sh
source ./atb/set_env.sh
```
## 1.2 libopchecker.so包
libopchecker.so包需要手动编译，步骤如下：

## 2. 输入数据
### 2.1 数据落盘
使用`ait llm dump --exec "bash run.sh patches/models/modeling_xxx.py" --type tensor op`将模型推理过程中的tensor数据及算子信息落盘，-ids可指定索引，-opname可指定算子类型，-o可指定输出目录。
Dump默认落盘路径 `{DUMP_DIR}`在当前目录下，如果指定output目录，落盘路径则为指定的 `{OUTPUT_DIR}`。

- tensor信息会生成在默认落盘路径的atb_temp目录下，具体路径是 `{DUMP_DIR}/{PID}_{TID}`目录下。
- 算子信息会生成在默认落盘路径的ait_dump目录下，具体路径是 `{DUMP_DIR}/ait_dump/operation_io_tensors/{PID}/operation_tensors_{executeCount}.csv`。

注：`{PID}`为进程号；`{TID}`为 `token_id`；`{executeCount}`为 `operation`运行次数。
### 2.2 算子信息文件重要列说明
|   表头   | 说明 |
| -------- | -------------------------------------------------- |
| OpName   | 算子名称，需要包含算子类名和以'_'分隔的算子拓扑结构名，示例：LinearOperation_1_1_0_0 |
| OpParam  | 算子参数，json格式 |
| OutDtype | 各个outtensor的数据类型，以','分隔，取值范围：float, float16, int8, int32, unit8, int16, uint16, uint32, int64, uint64, double, bool, string, complex64, complex128, bf16 |


## 3. 执行精度预检
### 3.1 使用示例
`ait llm opcheck -i {DUMP_DIR}/{PID}_{TID}/0/ -c {DUMP_DIR}/ait_dump/operation_io_tensors/{PID}/operation_tensors_{executeCount}.csv`
命令参数说明请参考[llm大模型推理精度工具功能说明_v0.2.1.md](./llm大模型推理精度工具功能说明_v0.2.1.md)
### 3.2 输出文件各列说明
|   表头   | 说明 |
| -------- | -------------------------------------------------- |
| op_id    | 算子id，以'_'分隔的算子拓扑结构名（从输入算子信息表中获取） |
| op_name  | 算子名称，格式为算子类名（参见[atb/infer_op_params.h中的Operation](https://www.hiascend.com/document/detail/zh/canncommercial/700/foundmodeldev/ascendtb/ascendtb_01_0045.html)） |
| op_param | 算子参数，同OpParam |
| tensor_path | 算子输入intensor的目录 |
| out_tensor_id |  算子输出outtensor的序号（部分算子输出可能有多个outtensor） |
| precision_standard | 采用的精度标准（参见3.3精度标准）|
| precision_result(%) | 实际的精度通过率（使用相对误差，全部通过则为100%）|
| excuted_information | 运行结果，execution successful为精度通过，execution failed为精度不通过或者算子执行失败，addition failed为算子添加失败（不支持该算子类型）|
| abs_pass_rate(%)    | 实际的绝对误差精度通过率 |
| cosine_similarity   | 余弦相似度 |
| kl_divergence       | kl散度 |
### 3.3 精度标准
每个DataType共有两项数据共同形成精度标准，其中第一项为误差级别，第二项为满足条件。例如，double对应的精度标准是满足Error小于0.0001误差级别的数据比例在99.99%以上，即双万分之一。
```
        self.precision_standard = {
            'double': [error1, 99.99], 'uint32': [error1, 99.99], 
            'int64': [error1, 99.99], 'float': [error1, 99.99], 'int32': [error1, 99.99], 
            'uint64': [error1, 99.99], 'float16': [error3, 99.9], 'bf16': [error4, 99.6], 
            'int8': [error6, 99.9], 'uint8': [error6, 99], 'int16': [error6, 99.9], 
            'uint16': [error6, 99.9], 'bool': [error1, 100]
        }
```
注：如果使用旧版atb，落下的DataType可能为大写格式（示例：`ACL_DOUBLE`）