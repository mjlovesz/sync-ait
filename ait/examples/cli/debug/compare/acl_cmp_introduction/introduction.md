

# 加速库在线推理精度比对工具介绍

加速库精度比对工具目前主要分为以下几个场景：

| 场景名称 | 场景介绍                                                     | 使用指导                                     |
| -------- | ------------------------------------------------------------ |------------------------------------------|
| 场景一   | pytorch-npu推理与加速库推理在同一个推理脚本中，开发者一般使用torch.allclose比对加速库推理输出与pytorch-npu推理输出之间的差异，但是无法直接比对加速库内部的数据与torch-npu的差异。 | [使用指导](../11_pta_acl_cmp/basic_usage.md) |
| 场景二   | pytorch-npu与加速库推理在两个推理脚本中，用户分别执行torch-npu推理和加速库推理，得到两份数据，以torch-npu作为基准数据，比对加速库与基准数据直接的差异。 |                                          |
| 场景三   | pytorch-gpu与加速库推理在两个推理脚本中，用户分别执行torch-gpu推理和加速库推理，得到两份数据，以torch-gpu作为基准数据，比对加速库与基准数据直接的差异。 |                                          |
| 场景四   | 以Operation（Layer）替换作为基准数据，比较Layer（Model）替换与基准的差异。 |                                          |

针对场景二和场景三，所有含有权重的算子，工具可以实现自动比对，不需要用户手动设置比对映射关系。对于部分没有权重的算子，可以使用半自动比对接口，定义映射关系，进行精度比对。流程图如下：

![场景2和场景3流程图](./场景2和场景3流程图.png)
- [自动映射使用指导](../12_pta_acl_cmp_weight_map/README.md)
- [半自动比对使用指导](../13_dump_and_compare/README.md)

## 精度问题定位流程
以下是参考的精度定位整体流程：
![精度定位流程图](./LocationProgress.png)
总体主要是三个步骤：数据集评测->回答差异分析->tensor差异分析
其中：
- 数据集评测是从performance这个维度评判模型精度，后续benchmark会支持自动数据集评测功能。
- 回答差异分析是从token这个维度评判模型精度，其中找到回答的差异句子后，分析差异句子的第几个词有差异，同时通过模型的token输出indices矩阵进行比较，可以判断出是哪个token轮次的推理结果有问题。
- tensor差异分析是本工具的主要功能，在定位到是第K个token的推理结果问题后，可以通过自动映射比对或者半自动设置第k轮次比对来完成逐tensor比对，逐步缩小范围。
